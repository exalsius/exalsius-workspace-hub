{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "DiLoCo Training Helm Chart Values",
  "description": "Schema for validating diloco-training Helm chart values",
  "type": "object",
  "$defs": {
    "global": {
      "type": "object",
      "description": "Global settings shared across subcharts",
      "properties": {
        "deploymentName": {
          "type": "string",
          "description": "Name of the deployment",
          "minLength": 1
        },
        "deploymentNamespace": {
          "type": "string",
          "description": "Kubernetes namespace for the deployment",
          "default": "default",
          "minLength": 1
        }
      },
      "required": ["deploymentName", "deploymentNamespace"],
      "additionalProperties": false
    },
    "deploymentNumReplicas": {
      "type": "integer",
      "description": "Number of deployment replicas.",
      "const": 1,
      "default": 1
    },
    "resources": {
      "type": "object",
      "description": "Resource configuration (reference section, set by Exalsius)",
      "properties": {
        "gpuCount": {
          "type": "integer",
          "description": "Number of GPUs to allocate",
          "minimum": 0
        },
        "gpuVendor": {
          "type": "string",
          "description": "GPU vendor configuration",
          "enum": ["NVIDIA", "AMD"]
        },
        "gpuType": {
          "type": "string",
          "description": "GPU type/model",
          "minLength": 1
        },
        "gpuMemory": {
          "type": "integer",
          "description": "GPU memory in gigabytes",
          "minimum": 0
        },
        "cpuCores": {
          "type": "integer",
          "description": "Number of CPU cores to allocate",
          "minimum": 1
        },
        "memoryGb": {
          "type": "integer",
          "description": "Memory allocation in gigabytes",
          "minimum": 1
        },
        "storageGb": {
          "type": "integer",
          "description": "Persistent storage size in gigabytes",
          "minimum": 1
        }
      },
      "required": ["gpuCount", "gpuVendor", "cpuCores", "memoryGb", "storageGb"],
      "additionalProperties": false
    }
  },
  "properties": {
    "elastic": {
      "type": "object",
      "description": "PyTorch Elastic training configuration with etcd rendezvous",
      "properties": {
        "minNodes": {
          "type": "integer",
          "description": "Minimum number of nodes for elastic training",
          "minimum": 1
        },
        "maxNodes": {
          "type": "integer",
          "description": "Maximum number of nodes for elastic training",
          "minimum": 1
        },
        "maxRestarts": {
          "type": "integer",
          "description": "Maximum restarts for elastic training",
          "minimum": 0,
          "default": 10
        },
        "rdzvTimeout": {
          "type": "integer",
          "description": "Timeout for rendezvous in seconds (optimized for high latency)",
          "minimum": 1,
          "default": 1800
        },
        "gpuDistribution": {
          "type": "string",
          "description": "GPU distribution policy (used when gpu.*.minNodes/maxNodes are null)",
          "enum": ["auto", "prefer-nvidia", "prefer-amd"],
          "default": "auto"
        },
        "nccl": {
          "type": "object",
          "description": "NCCL/RCCL configuration for high-latency environments",
          "properties": {
            "debug": {
              "type": "string",
              "description": "NCCL debug level",
              "enum": ["WARN", "INFO", "TRACE"],
              "default": "INFO"
            },
            "asyncErrorHandling": {
              "type": "integer",
              "description": "Enable async error handling for better fault tolerance",
              "enum": [0, 1],
              "default": 1
            },
            "timeout": {
              "type": "integer",
              "description": "NCCL operation timeout in seconds",
              "minimum": 1,
              "default": 1800
            },
            "ibTimeout": {
              "type": "integer",
              "description": "InfiniBand timeout (increase for high latency)",
              "minimum": 1,
              "default": 22
            },
            "nsocksPerThread": {
              "type": "integer",
              "description": "Number of sockets per thread (increase for high latency)",
              "minimum": 1,
              "default": 8
            },
            "socketNthreads": {
              "type": "integer",
              "description": "Number of threads per socket (increase for better utilization)",
              "minimum": 1,
              "default": 4
            },
            "socketIfname": {
              "type": "string",
              "description": "Network interface to use (e.g., eth0, ib0)"
            }
          },
          "additionalProperties": false
        },
        "etcd": {
          "type": "object",
          "description": "etcd rendezvous backend configuration",
          "properties": {
            "externalEndpoint": {
              "type": "string",
              "description": "External etcd endpoint (e.g., 'etcd.infrastructure.svc.cluster.local:2379')",
              "default": ""
            },
            "prefix": {
              "type": "string",
              "description": "etcd key prefix for job isolation",
              "default": "/torchelastic"
            },
            "protocol": {
              "type": "string",
              "description": "Protocol for etcd connection",
              "enum": ["http", "https"],
              "default": "http"
            },
            "runId": {
              "type": "string",
              "description": "Run ID for rendezvous (leave empty for auto-generated timestamp-based ID)",
              "default": ""
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["minNodes", "maxNodes"],
      "additionalProperties": false
    },
    "gpu": {
      "type": "object",
      "description": "GPU-specific configurations",
      "properties": {
        "nvidia": {
          "type": "object",
          "description": "NVIDIA GPU configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable NVIDIA GPU workers"
            },
            "image": {
              "type": "string",
              "description": "Container image for NVIDIA workers",
              "minLength": 1
            },
            "minNodes": {
              "type": ["integer", "null"],
              "description": "Minimum NVIDIA nodes (null means calculate from elastic config)",
              "minimum": 0
            },
            "maxNodes": {
              "type": ["integer", "null"],
              "description": "Maximum NVIDIA nodes (null means calculate from elastic config)",
              "minimum": 0
            },
            "runtimeClassName": {
              "type": "string",
              "description": "Kubernetes runtime class for NVIDIA GPUs"
            }
          },
          "required": ["enabled", "image"],
          "additionalProperties": false
        },
        "amd": {
          "type": "object",
          "description": "AMD GPU configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable AMD GPU workers"
            },
            "image": {
              "type": "string",
              "description": "Container image for AMD workers",
              "minLength": 1
            },
            "minNodes": {
              "type": ["integer", "null"],
              "description": "Minimum AMD nodes (null means calculate from elastic config)",
              "minimum": 0
            },
            "maxNodes": {
              "type": ["integer", "null"],
              "description": "Maximum AMD nodes (null means calculate from elastic config)",
              "minimum": 0
            },
            "runtimeClassName": {
              "type": "string",
              "description": "Kubernetes runtime class for AMD GPUs"
            }
          },
          "required": ["enabled", "image"],
          "additionalProperties": false
        }
      },
      "required": ["nvidia", "amd"],
      "additionalProperties": false
    },
    "diloco": {
      "type": "object",
      "description": "DiLoCo Training Environment Variables",
      "properties": {
        "model": {
          "type": "string",
          "description": "Model name or identifier"
        },
        "dataset": {
          "type": "string",
          "description": "Dataset name"
        },
        "localSteps": {
          "type": "integer",
          "description": "Number of local training steps",
          "minimum": 1
        },
        "lr": {
          "type": "number",
          "description": "Learning rate",
          "minimum": 0
        },
        "outerLr": {
          "type": "number",
          "description": "Outer optimizer learning rate",
          "minimum": 0
        },
        "warmupSteps": {
          "type": "integer",
          "description": "Number of warmup steps",
          "minimum": 0
        },
        "totalSteps": {
          "type": "integer",
          "description": "Total training steps",
          "minimum": 1
        },
        "perDeviceTrainBatchSize": {
          "type": "integer",
          "description": "Batch size per device",
          "minimum": 1
        },
        "batchSize": {
          "type": "integer",
          "description": "Global batch size",
          "minimum": 1
        },
        "optimMethod": {
          "type": "string",
          "description": "Optimization method"
        },
        "quantization": {
          "type": "boolean",
          "description": "Enable quantization"
        },
        "asyncCommunication": {
          "type": "boolean",
          "description": "Enable async communication"
        },
        "checkpointPath": {
          "type": "string",
          "description": "Path for checkpoint files"
        },
        "checkpointInterval": {
          "type": "integer",
          "description": "Checkpoint save interval",
          "minimum": 1
        },
        "device": {
          "type": "string",
          "description": "Device type (cuda/rocm)"
        },
        "wandbProjectName": {
          "type": "string",
          "description": "Weights & Biases project name"
        },
        "wandbGroup": {
          "type": "string",
          "description": "Weights & Biases group name"
        },
        "wandbRunId": {
          "type": "string",
          "description": "Weights & Biases run ID"
        },
        "heterogeneous": {
          "type": "boolean",
          "description": "Enable heterogeneous training"
        },
        "minBatchSize": {
          "type": "integer",
          "description": "Minimum batch size for heterogeneous training",
          "minimum": 1
        },
        "maxBatchSize": {
          "type": "integer",
          "description": "Maximum batch size for heterogeneous training",
          "minimum": 1
        },
        "groupPercVariance": {
          "type": "number",
          "description": "Group percentage variance",
          "minimum": 0
        },
        "compressionDecay": {
          "type": "number",
          "description": "Compression decay factor",
          "minimum": 0,
          "maximum": 1
        },
        "compressionTopk": {
          "type": "integer",
          "description": "Top-k compression value",
          "minimum": 1
        },
        "experimentDescription": {
          "type": "string",
          "description": "Description of the experiment"
        },
        "experimentTags": {
          "type": "string",
          "description": "Tags for the experiment (JSON array string)"
        },
        "seed": {
          "type": "integer",
          "description": "Random seed",
          "minimum": 0
        },
        "wandbLogging": {
          "type": "boolean",
          "description": "Enable Weights & Biases logging"
        },
        "wandbUserKey": {
          "type": "string",
          "description": "Weights & Biases API key"
        },
        "huggingfaceToken": {
          "type": "string",
          "description": "HuggingFace authentication token"
        },
        "compileModel": {
          "type": "boolean",
          "description": "Enable model compilation"
        },
        "compileBackend": {
          "type": "string",
          "description": "Compilation backend"
        },
        "compileMode": {
          "type": "string",
          "description": "Compilation mode"
        },
        "hfUpload": {
          "type": "boolean",
          "description": "Enable HuggingFace model upload"
        },
        "trainedModelHfName": {
          "type": "string",
          "description": "HuggingFace model name for upload"
        },
        "pgroupBackend": {
          "type": "string",
          "description": "Process group backend (nccl/gloo)"
        }
      },
      "additionalProperties": false
    },
    "etcd": {
      "type": "object",
      "description": "etcd subchart configuration (bitnami/etcd). Set enabled: false to use an external etcd cluster.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable embedded etcd subchart"
        },
        "persistence": {
          "type": "object",
          "description": "Persistence configuration for etcd"
        },
        "replicaCount": {
          "type": "integer",
          "description": "Number of etcd replicas",
          "minimum": 1
        },
        "image": {
          "type": "object",
          "description": "etcd container image configuration"
        },
        "auth": {
          "type": "object",
          "description": "etcd authentication configuration"
        },
        "livenessProbe": {
          "type": "object",
          "description": "Liveness probe configuration"
        },
        "readinessProbe": {
          "type": "object",
          "description": "Readiness probe configuration"
        },
        "extraEnvVars": {
          "type": "array",
          "description": "Additional environment variables for etcd"
        }
      },
      "required": ["enabled"],
      "additionalProperties": true
    },
    "global": {
      "$ref": "#/$defs/global"
    },
    "resources": {
      "$ref": "#/$defs/resources"
    },
    "deploymentNumReplicas": {
      "$ref": "#/$defs/deploymentNumReplicas"
    }
  },
  "required": [
    "elastic",
    "gpu",
    "diloco",
    "etcd",
    "global",
    "resources",
    "deploymentNumReplicas"
  ],
  "additionalProperties": false
}
